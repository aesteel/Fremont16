---
title: "Kernel UDs 2016"
author: "Anna Steel"
date: "October 19, 2016"
output: pdf_document
---

```{r, include=FALSE} 
# load packages
library(dplyr)
library(sp)
library(rgdal)
library(rgeos)
library(maptools)
library(ggplot2)
library(grid) 
library(cowplot)
library(viridis)
library(adehabitatLT)
library(adehabitatHR)
library(raster)        # extent(), res(), projection() 
library(stringr)       #str_pad()
#library(userfriendlyscience)

river3 = readOGR("C:/Users/Anna/Documents/GitHub/Fremont16/GIS/2004_channel","2004_channel_freTightclip")
map.proj = CRS(river3@proj4string@projargs)

```
# Kernel Utilization Distributions
### This script uses the temporally rediscretized dataset (currently only 20 sec steps) to create utilization distributions. Here I compare the 2016 data with the 2015 data for LFC - I excluded the WRC for coding simplicity, not scientific reasons. Utiltimately I plan to also consider variability in flow and fish size, but have not yet incorporated those additional variables. 

__________________

## Create kernel UD from tracks, using ALL tracks together
The fish positions are from both release phases (RelEv 1, 2, 3, 4, & 5) - includes 634 individuals after temporal rediscretization (Vemco Data, 20 sec steps)

_In 2015 the grid was automated to 10.03m squares, with a smoothing parameter h=3.03._ The kernelUD() function in adehabitatLT gives options for how to select a smoothing parameter for the bivariate normal probability space defined at each recorded fish position. In 2015 I used the least squares cross validation to select an appropriate value for h (smoothing parameter) - the algorithm looks for a value of the smoothing parameter (h) where the CV(h) is minimized. In 2015 the value selected for h for LFC was 3.03 (some stochasticity in this, changes slightly by run). _For 2016 I set the grid to 10m exactly._ I ran the kernelUD() function with both lscv and href [the ad hoc method of smoother selection, which is h = Sigma*n^(1/6)] approaches to estimating the smoothing parameter, as well as setting it to match the 2015 analysis (h=3.03). 

```{r kud 15, echo=FALSE}
  # read in RData object from 2015
      kud15 <- readRDS("Maestros/kud15_rds.RData")
        vud15 = getvolumeUD(kud15)
        
       #windows(width=4, height=4)
        image(vud15[[1]], col=heat.colors(12), main=paste(names(vud15)[1],"2015; h=LSCV"))
        xyz.15 <- as.image.SpatialGridDataFrame(vud15[[1]])
        contour(xyz.15, add=TRUE, nlevels=6, drawlabels=FALSE)
        
      print(paste("smoothing parameter h, lscv; 2015-LFC = ",round(kud15$LFC@h$h,3)))
      
  # save grid to reference for 2016 UD
    grid2015 = SpatialPixels(SpatialPoints(kud15[[1]]@grid ))
    
  # create an even 10x10m grid for 2016
    e = extent(615430, 615430+(61*10), 4290820, 4290820+(47*10))
    r = raster(e)
    res(r) = c(10,10)   
    projection(r) = map.proj 
    grid10 = SpatialPixels(SpatialPoints(coordinates(r)))
    
```

```{r kud 16 all fish,  echo=FALSE}      
  # create kud/vud for 2016
    red8.trdz = readRDS("Maestros/RediscTime_20s.RData")

    red8.grp = data.frame(grp=red8.trdz[,"run"])
     xytsp = (red8.trdz[,c("x","y")])
     coordinates(red8.grp) <- xytsp 
     proj4string(red8.grp) <- CRS("+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
     
   #kud16.lscv = kernelUD(red8.grp[,1], h="LSCV", kern="bivnorm", extent=0.1, grid=grid10); saveRDS(kud16.lscv, "Maestros/kud16_rds.Rdata")  # computationally intensive
    kud16.lscv = readRDS("Maestros/kud16_rds.RData") 
     print(paste0("smoothing parameter h, lscv; 2016-LFC = ",round(kud16.lscv$LFC@h$h,3)))

   # windows()
       plotLSCV(kud16.lscv)
       
    kud16.href = kernelUD(red8.grp[,1], h="href", kern="bivnorm", extent=0.1, grid=grid10)    
     print(paste0("smoothing parameter h, href; 2016-LFC = ",round(kud16.href$LFC@h$h,3)))
     
    kud16.h15 = kernelUD(red8.grp[,1], h=3.03, kern="bivnorm", extent=0.1, grid=grid10) # set same as lscv, 2015
```

```{r comp smooth 2016 all, echo=FALSE, fig.width=7, fig.height=10}        
     vud16.lscv <- getvolumeUD(kud16.lscv)
     vud16.href <- getvolumeUD(kud16.href)
     vud16.h15 <- getvolumeUD(kud16.h15) 

#  windows(width=10, height=3); 
      par(mfrow=c(1,3))
     image(vud16.lscv[[1]], col=heat.colors(12), main="LFC 2016; h=LSCV")
     xyz.lscv <- as.image.SpatialGridDataFrame(vud16.lscv[[1]])
      contour(xyz.lscv, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.href[[1]], col=heat.colors(12), main="LFC 2016; h=HREF")
     xyz.href <- as.image.SpatialGridDataFrame(vud16.href[[1]])
      contour(xyz.href, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.h15[[1]], col=heat.colors(12), main="LFC 2016; h=3.03")
     xyz.h15 <- as.image.SpatialGridDataFrame(vud16.h15[[1]])
      contour(xyz.h15, add=TRUE, nlevels=6, drawlabels=FALSE)  
      
  vud16 = vud16.h15 
   xyz.16 <- as.image.SpatialGridDataFrame(vud16[[1]])
  
```

## Compare 2016 UD with 2015 UD (for 2015-LFC)
```{r comp contour 15 16 all fish, echo=FALSE, fig.height=10, fig.width=4}
  # plot contours overlapping    
    #windows(width=10, height=3); 
   par(mfrow=c(1,3))
     contour(xyz.15, add=FALSE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="red", main="25% contour")
     contour(xyz.16, add=TRUE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="steelblue2")
     legend("topleft", legend=c("2015","2016"), fill=c("red","steelblue2"))
     contour(xyz.15, add=FALSE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="red", main="50% contour")
     contour(xyz.16, add=TRUE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="steelblue2")
     contour(xyz.15, add=FALSE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="red", main="75% contour")
     contour(xyz.16, add=TRUE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="steelblue2")
```


__________________________________


# Comparing similar flows (low flows) across years
In 2015 the river stage was at nearly 15 ft during all releases. In 2016 there was much more variability, with stages ranging from 16.3 to 35.93. 

## Raw stage data
```{r cdec data, echo=FALSE}
   # Stage data     
 frestg = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/Maestros/FRE_stage_2016study.csv")
   frestg = frestg[!is.na(frestg$stage_ft),]
   frestg = frestg[frestg$stage_ft > 5 ,] # some missing values are recorded as 2 or 5; remove these entirely
   frestg$timePST = str_pad(frestg$timePST, 4, pad = "0")
   frestg$datetimePST = as.POSIXct(paste(frestg$datePST, frestg$timePST), format="%Y%m%d %H%M", tz="Etc/GMT-8")
   frestg$datetimeUTC = as.POSIXct(as.character(frestg$datetimePST + (60*60*8)), tz="GMT")
   frestg = frestg[order(frestg$datetimePST),]
   frestg$stageid = rownames(frestg)
   
    # Fish Releases
    fishrel = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/Maestros/TagReleaseList.csv", colClasses=c("RelTime"="character"))
     fishrel$datetime = as.POSIXct(paste(fishrel$RelDate, fishrel$RelTime), format="%Y-%m-%d %H%M", tz="Etc/GMT-8")
     fishrel = fishrel[fishrel$RelLoc=="TISDALE",]
     fishrel$TagID = NULL
     fishrel = fishrel[!duplicated(fishrel),]
     
    # merge stage into release dataset 
   frestg = frestg[order(frestg$datetimePST),]
   fishrel = fishrel[order(fishrel$datetime),]
    
        # magic step! thanks stack exchange!
      fishrel$cdecStgIndex <- 
         findInterval( fishrel$datetime, c(-Inf, head(frestg$datetimePST,-1))+ c(0,diff(as.numeric(frestg$datetimePST))/2 )) 
    
      fishrel = merge( fishrel, frestg[,c("stage_ft", "datetimePST","stageid")], by.y="stageid", by.x="cdecStgIndex", all.x=T)
      
  hydrograph.rel = ggplot(data=frestg, aes(y=stage_ft, x=datetimePST)) + geom_line() +
    geom_point(data=fishrel, aes(y=stage_ft, x=datetimePST, col=factor(RelEv)), pch=16, cex=4) + 
    geom_hline(aes(yintercept=33), lty=2, col="grey50") + 
    xlab("Date (PST)") + ylab("Stage @ Fremont Weir") + 
    ggtitle("Fish Release Dates by Sacramento River Stage\n(CDEC gauge @ FRE)") + 
    scale_colour_discrete(name="Release")
  png("Graphics/ReleaseDate_by_Stage.png", width=8, height=5, units="in", res=600)
   hydrograph.rel
  dev.off()
  
  hydrograph.rel
  
```  

## Summary of the flows experienced by each release group
```{r kud 16 low flows, echo=FALSE} 
  print(data.frame(summarize(group_by(red8.trdz, RelEv), mn.stg=mean(stage_ft), max.stg=max(stage_ft), min.stg=min(stage_ft), nfish=length(unique(id)))))
     
    redrel1 = data.frame(grp=red8.trdz[red8.trdz$RelEv==1,"run"])
     xyrel1 = (red8.trdz[red8.trdz$RelEv==1,c("x","y")])
     coordinates(redrel1) <- xyrel1 
     proj4string(redrel1) <- CRS("+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
     
   #kud16.rel1.lscv = kernelUD(redrel1[,1], h="LSCV", kern="bivnorm", extent=0.1, grid=grid10)
   #  saveRDS(kud16.rel1.lscv, "Maestros/kud16.rel1.lscv.Rdata")  # computationally intensive
     kud16.rel1.lscv = readRDS("Maestros/kud16.rel1.lscv.RData") 
     print(paste0("smoothing parameter h, lscv; 2016-LFC = ",round(kud16.rel1.lscv$LFC@h$h,3)))

   # windows()
       plotLSCV(kud16.lscv)
       
    kud16.rel1.href = kernelUD(redrel1[,1], h="href", kern="bivnorm", extent=0.1, grid=grid10)    
     print(paste0("smoothing parameter h, href; 2016-LFC = ",round(kud16.rel1.href$LFC@h$h,3)))
     
    kud16.rel1.h15 = kernelUD(redrel1[,1], h=3.03, kern="bivnorm", extent=0.1, grid=grid10) # set same as lscv, 2015
```

```{r comp smooth 2016 rel1, echo=FALSE, fig.width=7, fig.height=10}        
     vud16.rel1.lscv <- getvolumeUD(kud16.rel1.lscv)
     vud16.rel1.href <- getvolumeUD(kud16.rel1.href)
     vud16.rel1.h15 <- getvolumeUD(kud16.rel1.h15) 

#  windows(width=10, height=3); 
      par(mfrow=c(1,3))
     image(vud16.rel1.lscv[[1]], col=heat.colors(12), main="LFC 2016, rel1; h=LSCV")
     xyz.lscv <- as.image.SpatialGridDataFrame(vud16.rel1.lscv[[1]])
      contour(xyz.lscv, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.rel1.href[[1]], col=heat.colors(12), main="LFC 2016, rel1; h=HREF")
     xyz.href <- as.image.SpatialGridDataFrame(vud16.rel1.href[[1]])
      contour(xyz.href, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.rel1.h15[[1]], col=heat.colors(12), main="LFC 2016, rel1; h=3.03")
     xyz.h15 <- as.image.SpatialGridDataFrame(vud16.rel1.h15[[1]])
      contour(xyz.h15, add=TRUE, nlevels=6, drawlabels=FALSE)  
      
  vud16.rel1 = vud16.rel1.h15 
   xyz.rel1.16 <- as.image.SpatialGridDataFrame(vud16.rel1[[1]])
  
```

## Compare 2016 UD with 2015 UD (for 2015-LFC)
```{r comp contours rel1-16 15 fish, echo=FALSE, fig.height=10, fig.width=4}
  # plot contours overlapping    
    #windows(width=10, height=3); 
   par(mfrow=c(1,3))
     contour(xyz.15, add=FALSE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="red", main="25% contour")
     contour(xyz.rel1.16, add=TRUE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="steelblue2")
     legend("topleft", legend=c("2015","2016, Rel1"), fill=c("red","steelblue2"))
     contour(xyz.15, add=FALSE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="red", main="50% contour")
     contour(xyz.rel1.16, add=TRUE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="steelblue2")
     contour(xyz.15, add=FALSE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="red", main="75% contour")
     contour(xyz.rel1.16, add=TRUE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="steelblue2")
```


______________________

# Comparing low and high flows within 2016
 
```{r kud 16 rel1 v rel45 flows, echo=FALSE} 
    redrel45 = data.frame(grp=red8.trdz[red8.trdz$RelEv%in%c(4,5),"run"])
     xyrel45 = (red8.trdz[red8.trdz$RelEv%in%c(4,5),c("x","y")])
     coordinates(redrel45) <- xyrel45
     proj4string(redrel45) <- CRS("+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
     
   # kud16.rel45.lscv = kernelUD(redrel45[,1], h="LSCV", kern="bivnorm", extent=0.1, grid=grid10) # computationally intensive
   #  saveRDS(kud16.rel45.lscv, "Maestros/kud16.rel45.lscv.RData")  
     kud16.rel45.lscv = readRDS("Maestros/kud16.rel45.lscv.RData") 
     print(paste0("smoothing parameter h, lscv; 2016-LFC, Rel 4 & 5 = ",round(kud16.rel45.lscv$LFC@h$h,3)))

   # windows()
       plotLSCV(kud16.rel45.lscv)
       
    kud16.rel45.href = kernelUD(redrel45[,1], h="href", kern="bivnorm", extent=0.1, grid=grid10)    
     print(paste0("smoothing parameter h, href; 2016-LFC = ",round(kud16.rel45.href$LFC@h$h,3)))
     
    kud16.rel45.h15 = kernelUD(redrel45[,1], h=3.03, kern="bivnorm", extent=0.1, grid=grid10) # set same as lscv, 2015
```

```{r compare smooth rel45 2016, echo=FALSE, fig.width=7, fig.height=10}        
     vud16.rel45.lscv <- getvolumeUD(kud16.rel45.lscv)
     vud16.rel45.href <- getvolumeUD(kud16.rel45.href)
     vud16.rel45.h15 <- getvolumeUD(kud16.rel45.h15) 

#  windows(width=10, height=3); 
      par(mfrow=c(1,3))
     image(vud16.rel45.lscv[[1]], col=heat.colors(12), main="LFC 2016, rel45; h=LSCV")
     xyz.lscv <- as.image.SpatialGridDataFrame(vud16.rel45.lscv[[1]])
      contour(xyz.lscv, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.rel45.href[[1]], col=heat.colors(12), main="LFC 2016, rel45; h=HREF")
     xyz.href <- as.image.SpatialGridDataFrame(vud16.rel45.href[[1]])
      contour(xyz.href, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.rel45.h15[[1]], col=heat.colors(12), main="LFC 2016, rel45; h=3.03")
     xyz.h15 <- as.image.SpatialGridDataFrame(vud16.rel45.h15[[1]])
      contour(xyz.h15, add=TRUE, nlevels=6, drawlabels=FALSE)  
      
  vud16.rel45 = vud16.rel45.h15 
   xyz.rel45.16 <- as.image.SpatialGridDataFrame(vud16.rel45[[1]])
  
```

## Compare rel1 2016 UD with rel4,5 2016 UD with consistent smoothing (h=3.03)
```{r comp contour rel45 fish, echo=FALSE, fig.height=10, fig.width=4}
  # plot contours overlapping    
    #windows(width=10, height=3); 
   par(mfrow=c(1,3))
     contour(xyz.rel1.16, add=FALSE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="red", main="25% contour")
     contour(xyz.rel45.16, add=TRUE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="steelblue2")
     legend("topleft", legend=c("2015","2016, rel45"), fill=c("red","steelblue2"))
     contour(xyz.rel1.16, add=FALSE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="red", main="50% contour")
     contour(xyz.rel45.16, add=TRUE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="steelblue2")
     contour(xyz.rel1.16, add=FALSE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="red", main="75% contour")
     contour(xyz.rel45.16, add=TRUE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="steelblue2")
```



______________________

# Comparing rel1 and rel3 in 2016, (rel 3 = just prior to overtopping)
 
```{r kud 16 rel1 v rel3 flows, echo=FALSE} 
    redrel3 = data.frame(grp=red8.trdz[red8.trdz$RelEv%in%c(3),"run"])
     xyrel3 = (red8.trdz[red8.trdz$RelEv%in%c(3),c("x","y")])
     coordinates(redrel3) <- xyrel3
     proj4string(redrel3) <- CRS("+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")
     
   # kud16.rel3.lscv = kernelUD(redrel3[,1], h="LSCV", kern="bivnorm", extent=0.1, grid=grid10) # computationally intensive
   #  saveRDS(kud16.rel3.lscv, "Maestros/kud16.rel3.lscv.RData")  
     kud16.rel3.lscv = readRDS("Maestros/kud16.rel3.lscv.RData") 
     print(paste0("smoothing parameter h, lscv; 2016-LFC, Rel 4 & 5 = ",round(kud16.rel3.lscv$LFC@h$h,3)))

   # windows()
       plotLSCV(kud16.rel3.lscv)
       
    kud16.rel3.href = kernelUD(redrel3[,1], h="href", kern="bivnorm", extent=0.1, grid=grid10)    
     print(paste0("smoothing parameter h, href; 2016-LFC = ",round(kud16.rel3.href$LFC@h$h,3)))
     
    kud16.rel3.h15 = kernelUD(redrel3[,1], h=3.03, kern="bivnorm", extent=0.1, grid=grid10) # set same as lscv, 2015
```

```{r comp smooth rel3 2016, echo=FALSE, fig.width=7, fig.height=10}        
     vud16.rel3.lscv <- getvolumeUD(kud16.rel3.lscv)
     vud16.rel3.href <- getvolumeUD(kud16.rel3.href)
     vud16.rel3.h15 <- getvolumeUD(kud16.rel3.h15) 

#  windows(width=10, height=3); 
      par(mfrow=c(1,3))
     image(vud16.rel3.lscv[[1]], col=heat.colors(12), main="LFC 2016, rel3; h=LSCV")
     xyz.lscv <- as.image.SpatialGridDataFrame(vud16.rel3.lscv[[1]])
      contour(xyz.lscv, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.rel3.href[[1]], col=heat.colors(12), main="LFC 2016, rel3; h=HREF")
     xyz.href <- as.image.SpatialGridDataFrame(vud16.rel3.href[[1]])
      contour(xyz.href, add=TRUE, nlevels=6, drawlabels=FALSE)  
     image(vud16.rel3.h15[[1]], col=heat.colors(12), main="LFC 2016, rel3; h=3.03")
     xyz.h15 <- as.image.SpatialGridDataFrame(vud16.rel3.h15[[1]])
      contour(xyz.h15, add=TRUE, nlevels=6, drawlabels=FALSE)  
      
  vud16.rel3 = vud16.rel3.h15 
   xyz.rel3.16 <- as.image.SpatialGridDataFrame(vud16.rel3[[1]])
  
```

## Compare rel1 2016 UD with rel4,5 2016 UD with consistent smoothing (h=3.03)
```{r comp contours rel1 v rel3 fish, echo=FALSE, fig.height=10, fig.width=4}
  # plot contours overlapping    
    #windows(width=10, height=3); 
   par(mfrow=c(1,3))
     contour(xyz.rel1.16, add=FALSE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="red", main="25% contour")
     contour(xyz.rel3.16, add=TRUE, nlevels=5, levels=25, drawlabels=FALSE, lwd=2.5, col="steelblue2")
     legend("topleft", legend=c("2015","2016, rel3"), fill=c("red","steelblue2"))
     contour(xyz.rel1.16, add=FALSE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="red", main="50% contour")
     contour(xyz.rel3.16, add=TRUE, nlevels=5, levels=50, drawlabels=FALSE, lwd=2.5,col="steelblue2")
     contour(xyz.rel1.16, add=FALSE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="red", main="75% contour")
     contour(xyz.rel3.16, add=TRUE, nlevels=5, levels=75, drawlabels=FALSE, lwd=2.5,col="steelblue2")
```
