---
title: "Rediscretizing Tracks"
author: "Anna Steel"
date: "August 16, 2016"
output: pdf_document
---
```{r, include=FALSE} 
# required packages
library(dplyr)
library(sp)
library(rgdal)
library(rgeos)
library(maptools)
library(ggplot2)
library(grid) 
library(cowplot)
library(viridis)
library(adehabitatLT)
library(adehabitatHR)
#library(userfriendlyscience)

river3 = readOGR("C:/Users/Anna/Documents/GitHub/Fremont16/GIS/2004_channel","2004_channel_freTightclip")

```


### Rediscretization of Tracks
- Using primary and secondary filtered data to rediscretize tracks for further analysis
- Tracks have been split into bursts where successive positions were seperated by > 50m
* this threshold can be altered in "Final_Filtering.Rmd" if desired
- Before redistretizing, remove bursts with < 10 positions (too few to rediscretize in adehabitatLT)

```{r}
  load("Maestros/AllFish_FiltSec4Bursts.RData")  # single object, named red7
 
 dim(red7) # 102633 detections 
    length(unique(red7$id))  # 430 unique fish
    length(unique(red7$burst))  # 588 unique bursts
    
    ndetects.fish = summarize(group_by(red7, id), ndet = n())  
      mean(ndetects.fish$ndet) # 238.9 per fish
      range(ndetects.fish$ndet) # ranges from 28 - 660
    ndetects.burst = summarize(group_by(red7, burst), ndet = n())  
      mean(ndetects.burst$ndet) # 174.5 per fish
      range(ndetects.burst$ndet) # ranges from 3 - 660
      
    max(red7$spd_mps, na.rm=T)  # 86.6 mps
```

```{r}
  bursts.rem = data.frame(ndetects.burst[ndetects.burst$ndet<10,])
     nrow(bursts.rem) # 74 bursts removed
    sum(bursts.rem$ndet) # 373 positions removed
  red.br =  red7[(red7$burst %in% bursts.rem$burst),] 
  
  ggplot(data = red.br, aes(x=east, y=north)) + geom_point() + 
    geom_path(data = river3, aes(long, lat), col="gold", size=1.2 ) +
    ggtitle(label = "Positions Removed within Short Bursts") +
    theme_bw() + coord_fixed()
    
  red8 = red7[!(red7$burst %in% bursts.rem$burst),]
  
  dim(red8) # 10796 detections after discretization
    length(unique(red8.ssrdz$id))  # 439
    ndetects.discr = summarize(group_by(red8.ssrdz, id), ndet = n())  
      mean(ndetects.discr$ndet) # 28.75 per fish
      range(ndetects.discr$ndet) # ranges from 10 - 41
    max(red8.ssrdz$spd_mps, na.rm=T)  # 73.11 mps
  # prep object for redisltraj()
  red8.ltraj = as.ltraj(xy=red8[,c("east","north")], date=red8$date, 
                        id=red8$id, burst = factor(red8$burst),
                        infolocs=red8[,c("Hpes","east","north")])
```

```{r}
  # discretize in space
  redlt.ssrdz = (redisltraj(red8.ltraj, u=25, type="space", nnew=5)) 
    # u=25 is the smallest distance where the code will work.

  # convert back to dataframe
   red8.ssrdz = ld(redlt.ssrdz)
     red8.ssrdz=red8.ssrdz[order(red8.ssrdz$id,red8.ssrdz$date),]
```


Recalculated migration speed between positions now that they have been rediscretized.

Also will add extra information back into dataframe to possibly use later, but need to wait until I've sorted that info from Jon's hard-drive

Save the discretized object to RData

Note: In 2015 I removed tracks which had < 10 positions after spatial discretization. However, this year's anaysis is slightly different since I'm working with bursts  ->  we should have already controlled for sparse tracks (i.e., those where interpolation might be inapporpriate). Plus, above I've removed any burst with < 10 positions. Therefore, I'm imposing no additional filtering after discretization. 

```{r, echo=FALSE}
 # recalculate migration speed  
   red8.ssrdz$spd_mps = red8.ssrdz$dist / red8.ssrdz$dt
     
  ##### Do I need to recalculate the turning angles and everything else still? #####   

#  # add in extra info when I get it from Jon
#    tagrel = read.csv("DATA/Maestro_tagging_WRC-LFC.csv")
#       tagrel = tagrel[,c("ID.Tag","Species","Time.Date.Release","RelEv","Weight","Fork.Length")] # time in PST
#       names(tagrel) = c("id","run","datetime.Rel","RelEv","Weight","FL")
#        
#       library(plyr)
#        red8.ssrdz = join(red8.ssrdz, tagrel, type="left")
#       detach(package:plyr)
#   
#       red8.ssrdz$RelHr = as.POSIXlt(red8.ssrdz$datetime.Rel, format="%m/%d/%Y %H:%M")$hour
#       red8.ssrdz$datetime.Rel = NULL

  ## write this to file
  saveRDS(red8.ssrdz, "Maestros/RediscSpat_25m.RData")
```



And finally, output the general metrics about the remaining dataset
```{r}
    dim(red8.ssrdz) # 10796 detections after discretization
    length(unique(red8.ssrdz$id))  # 439
    ndetects.discr = summarize(group_by(red8.ssrdz, id), ndet = n())  
      mean(ndetects.discr$ndet) # 28.75 per fish
      range(ndetects.discr$ndet) # ranges from 10 - 41
    max(red8.ssrdz$spd_mps, na.rm=T)  # 73.11 mps
    ```
