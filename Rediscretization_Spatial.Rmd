---
title: "Rediscretizing Tracks"
author: "Anna Steel"
date: "August 16, 2016"
output: pdf_document
---
```{r, include=FALSE} 
# required packages
library(dplyr)
library(sp)
library(rgdal)
library(rgeos)
library(maptools)
library(ggplot2)
library(grid) 
library(cowplot)
library(viridis)
library(adehabitatLT)
library(adehabitatHR)
library(stringr)
#library(userfriendlyscience)

river3 = readOGR("C:/Users/Anna/Documents/GitHub/Fremont16/GIS/2004_channel","2004_channel_freTightclip")

```
## These analyses only consider the first two releases, intended as Phase 1 (phase 2 = survival study)
However, there were 221 additional fish released in phases 3 - 5 that could be incorporated. They were released at higher flows, which would add interesting complexity, and additional analysis needs. 

### Rediscretization of Tracks
- Using primary and secondary filtered data to rediscretize tracks for further analysis
- Tracks have been split into bursts where successive positions were seperated by > 50m
* this threshold can be altered in "Final_Filtering.Rmd" if desired
- Before redistretizing, remove bursts with < 10 positions (too few to rediscretize in adehabitatLT)
- After, recalculated migration speed between positions

```{r}
  load("Maestros/AllFish_FiltSec4Bursts.RData")  # single object, named red7
 
 dim(red7) # 102633 detections 
    length(unique(red7$id))  # 430 unique fish
    length(unique(red7$burst))  # 588 unique bursts
    
    ndetects.fish = summarize(group_by(red7, id), ndet = n())  
      mean(ndetects.fish$ndet) # 238.9 per fish
      range(ndetects.fish$ndet) # ranges from 28 - 660
    ndetects.burst = summarize(group_by(red7, burst), ndet = n())  
      mean(ndetects.burst$ndet) # 174.5 per fish
      range(ndetects.burst$ndet) # ranges from 3 - 660
      
    max(red7$spd_mps, na.rm=T)  # 86.6 mps
```

```{r}
  bursts.rem = data.frame(ndetects.burst[ndetects.burst$ndet<10,])
     nrow(bursts.rem) # 74 bursts removed
    sum(bursts.rem$ndet) # 373 positions removed
  red.br =  red7[(red7$burst %in% bursts.rem$burst),] 
  
  river3 = fortify(river3)
  ggplot(data = red.br, aes(x=east, y=north)) + geom_point() + 
    geom_path(data = river3, aes(long, lat), col="gold", size=1.2 ) +
    ggtitle(label = "Positions Removed within Short Bursts") +
    theme_bw() + coord_fixed()
    
  red8 = red7[!(red7$burst %in% bursts.rem$burst),]
  
  # prep object for redisltraj()
  red8.ltraj = as.ltraj(xy=red8[,c("east","north")], date=red8$date, 
                        id=red8$id, burst = factor(red8$burst),
                        infolocs=red8[,c("Hpes","east","north")])
```

```{r}
  # discretize in space
  redlt.ssrdz = (redisltraj(red8.ltraj, u=25, type="space", nnew=5)) 
    # u=25 is the smallest distance where the code will work.

  # convert back to dataframe
   red8.ssrdz = ld(redlt.ssrdz)
     red8.ssrdz=red8.ssrdz[order(red8.ssrdz$id,red8.ssrdz$date),]
     
  # recalculate migration speed  
   red8.ssrdz$spd_mps = red8.ssrdz$dist / red8.ssrdz$dt
   
    dim(red8.ssrdz) # 10796 detections after discretization
    length(unique(red8.ssrdz$id))  # 439
    ndetects.discr = summarize(group_by(red8.ssrdz, id), ndet = n())  
      mean(ndetects.discr$ndet) # 28.75 per fish
      range(ndetects.discr$ndet) # ranges from 10 - 41
    max(red8.ssrdz$spd_mps, na.rm=T)  # 73.11 mps

```




Add covariates (release event, river stage) back into dataframe to possibly use later
*Compared un-QAQCed data on river stage from CDEC station (no discharge available) with USGS measured values

Save the discretized object to RData

Note: In 2015 I removed tracks which had < 10 positions after spatial discretization. However, this year's anaysis is slightly different since I'm working with bursts  ->  we should have already controlled for sparse tracks (i.e., those where interpolation might be inapporpriate). Plus, above I've removed any burst with < 10 positions. Therefore, I'm imposing no additional filtering after discretization. 

```{r, echo=FALSE}

    # SacRiver Stage - measured by USGS
#   stage = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/Maestros/SacDischarge.csv", colClasses=c("TimePST"="character"))
#    stage$datetimePST = as.POSIXct(paste(stage$DatePST,stage$TimePST), format="%Y-%m-%d %H:%M")
#    relstg = stage[,c("DatePST","datetimePST","Stage_ft","Vel_fps","MeasQ_cfs")]
    
    # data rounded to quarter hours where appropriate; otherwise deleted
  stager = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/Maestros/SacDischargeRoundedtime.csv", colClasses=c("TimePST"="character"))
   stager$datetimePST = as.POSIXct(paste(stager$DatePST,stager$TimePST), format="%Y-%m-%d %H:%M")
   relstgr = stager[,c("DatePST","datetimePST","stage_ft")]
  
  # SacRiver Stage - pulled from CDEC - ask for QAQC data from DWR if this seems okay 
  frestg = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/Maestros/FRE_stage_2016study.csv")
  frestg = frestg[!is.na(frestg$stage_ft),]
  frestg = frestg[frestg$stage_ft > 5 ,] # some missing values are recorded as 2 or 5; remove these entirely
   frestg$timePST = str_pad(frestg$timePST, 4, pad = "0")
   frestg$datetimePST = as.POSIXct(paste(frestg$datePST, frestg$timePST), format="%Y%m%d %H%M", tz="Etc/GMT-8")
   frestg$datetimeUTC = as.POSIXct(as.character(frestg$datetimePST + (60*60*8)), tz="GMT")
   frestg = frestg[order(frestg$datetimePST),]
   frestg$stageid = rownames(frestg)
  

  
  ## compare the usgs and the cdec gauge data 
   compare = merge(relstgr, frestg, all.x=T, by="datetimePST")
    compare$stage_ft.x - compare$stage_ft.y
    
  hist(compare$stage_ft.x - compare$stage_ft.y)
   mean(compare$stage_ft.x - compare$stage_ft.y, na.rm=T)
   # -1.33
   sd(compare$stage_ft.x - compare$stage_ft.y, na.rm=T)
   # 0.37
   
   
   
 ## merge onto position dataset
   red8.ssrdz = red8.ssrdz[order(red8.ssrdz$date),]

    # magic step! thanks stack exchange!
  red8.ssrdz$cdecStgIndex <- 
     findInterval( red8.ssrdz$date, c(-Inf, head(frestg$datetimeUTC,-1))+ c(0,diff(as.numeric(frestg$datetimeUTC))/2 )) 

  red8.ssrdz = merge( red8.ssrdz, frestg[,c("stage_ft", "datetimeUTC","stageid")], by.y="stageid", by.x="cdecStgIndex", all.x=T)
    red8.ssrdz$cdecStgIndex = NULL
    red8.ssrdz = red8.ssrdz[order(red8.ssrdz$date),]

  
    
  # Fish Releases
    fishrel = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/Maestros/TagReleaseList.csv", colClasses=c("RelTime"="character"))
        fishrel$datetime = as.POSIXct(paste(fishrel$RelDate, fishrel$RelTime), format="%Y-%m-%d %H%M", tz="Etc/GMT-8")
        names(fishrel)[3] <- "id"
        names(fishrel)[ncol(fishrel)] <- "datetime.Rel"
        
   red8.ssrdz = merge(red8.ssrdz, fishrel[,c("RelEv","CanID","id","RelLoc","datetime.Rel")], all.x=T)
  
   red8.ssrdz$RelHr = as.POSIXlt(red8.ssrdz$datetime.Rel)$hour

   
  # plot releases against the hydrograph of stage; uses magic step again! 
   fishrel$RelIndex <- 
     findInterval( fishrel$datetime.Rel, c(-Inf, head(frestg$datetimePST,-1))+ c(0,diff(as.numeric(frestg$datetimePST))/2 )) 

   hgdat = merge( fishrel, frestg[,c("stage_ft", "datetimePST","stageid")], by.y="stageid", by.x="RelIndex", all.x=T)

   
   hg = ggplot(frestg, aes(x=datetimePST, y=stage_ft)) + geom_line() + geom_point(data=hgdat, aes(x=datetime.Rel, y=stage_ft), col="red", pch=16, cex=4) + ggtitle("River Stage at Fremont Weir \n(cdec gauge)") + xlab("Date (PST)") + ylab("River Stage (ft)") + scale_colour_manual(name = "", values =c('red'='red'), labels = c('Release'))
     
   hg
   
  ## write this to file
  saveRDS(red8.ssrdz, "Maestros/RediscSpat_25m.RData")
```



And finally, output the general metrics about the remaining dataset
```{r}
    dim(red8.ssrdz) # 10796 detections after discretization
    length(unique(red8.ssrdz$id))  # 430
    ndetects.discr = summarize(group_by(red8.ssrdz, id), ndet = n())  
      mean(ndetects.discr$ndet) # 28.11 per fish
      range(ndetects.discr$ndet) # ranges from 6 - 37
    max(red8.ssrdz$spd_mps, na.rm=T)  # 20.49 mps
    ```
