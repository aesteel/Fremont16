---
title: "Data Filtering Process, Condensed"
author: "Anna Steel"
date: "August 12, 2016"
output: html_document
---

## Filtering of VEMCO post-processed VPS positions

This code runs from the datafiles provided by VEMCO, and builds final datasets for analysis
Also includes reference numbers to track how filtering affects the dataset

__metrics considered include number of positions, number of fish in dataset, and positions per fish__

* filters by HPE: see 'Exploration_DataFiltering' for details
* filters by speed:
* filters for likely predators:
* filters out sparse tracks:
* breaks apart tracks with large gaps (for subsequent smoothing/rediscretization)

```{r, include=FALSE} 
# required packages
library(dplyr)
library(sp)
library(rgdal)
library(rgeos)
library(ggplot2)
library(grid) 
library(cowplot)
library(viridis)
```

### Read in Data & Clean for proper dates and TagIDs
- Open script from Fremont16.Rproj in GitHub to ensure directories are correct
``` {r, echo=FALSE}
 load("Maestros/alldf.RData")
 options("digits.secs"=6)
 alldf$Time <- as.POSIXct(as.character(alldf$Time), format="%Y-%m-%d %H:%M:%OS", tz = "GMT")

 # incomplete array
 alldfg <- alldf[alldf$Time > as.POSIXct("2016-02-109 14:00:00", tz="GMT"),]
  print(paste0(nrow(alldf) - nrow(alldfg)," positions removed due to incomplete VPS array"))
 
 # N fish & total N positions
 print(paste0("Prior to filtering, ",nrow(alldf)," total positions in dataset"))
 print(paste0("Prior to filtering, ",length(unique(alldf$Id))," individual fish positioned"))

 # N pos per fish 
  all.npf = alldfg %>%
   group_by(Id) %>%
   summarize(npos.all=n())%>%
   data.frame()

  print("Summary of N positions per fish, after reducing to applicable data")
  summary(all.npf$npos.all)
```

### HPE filter: <1.0 HPEs
After filtering @ HPEs < 1, dataset retained:
```{r, echo=FALSE}
 reddf = alldfg[alldfg$Hpes < 1,]
  
  # N fish & total N positions
   print(paste0(nrow(reddf)," positions")) # 110,211  
    print(paste0("   ",round(nrow(reddf)/nrow(alldfg)*100,2), "% of fish tag positions"))  # 84.35%
   print(paste0(length(unique(reddf$Id))," individual fish"))  # 438
    print(paste0("   ",round((length(unique(reddf$Id))/length(unique(alldf$Id)))*100,1),"% of individual fish retained "))  # 438
   
   
  # N pos per fish after HPE filtering
  red.npf = reddf %>%
   group_by(Id) %>%
   summarize(npos.red= n()) %>%
   data.frame()
  
  print("Summary of N positions per fish, after filtering at HPE<1")
  summary(red.npf$npos.red)   

```

#### Write out HPE filtered dataset
```{r}
  save(reddf, file="Maestros/AllFishPrimaryFilt.RData")
```
## End of Primary Filtering Process

***

## Beginning of Secondary Filtering Process

### Excessive Speeds Filtering
```{r}

# Critical to order this properly for the ordered step analysis below (TypeI)
reddf = reddf[order(reddf$Id, reddf$Time),]  
  reddf$IDcol = 1:nrow(reddf)

# # convert the Lat Long into UTMs using 'sp'
 reddf.sp <- SpatialPointsDataFrame(coords = reddf[,c("Longitude","Latitude")], 
              data = reddf, 
              proj4string=CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"))
        # confirmed string with VEMCO; the XY coords in azimuthal equal area
 reddf.utm <- spTransform(reddf.sp, 
                          CRS("+proj=utm +zone=10 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0"))
 reddf.utm@data[,c("east","north")] <- reddf.utm@coords
 
 reddf2 = reddf.utm@data    
 
 # calculate speed and distance with adehabitatLT
 red.ltraj = as.ltraj(xy=reddf2[,c("east","north")], date=reddf2$Time, 
                        id=reddf2$Id, infolocs = reddf2[,c("Id","Hpes","east","north")])
 
 red2 = ld(red.ltraj)
 red2$spd_mps = red2$dist / red2$dt
 
 # identify 'bad' positions (99%ile of step-speeds is ~7.7mps
 red2$prevspd = lag(red2$dist)/lag(red2$dt)

 red2$badpos <- 0
  red2$badpos[red2$spd_mps>7.7 & red2$prevspd>7.7] <- 1

 # filter out bad positions    
 red3 = red2[red2$badpos==0,]
 
 # recalculate speed and distance
 red3.ltraj = as.ltraj(xy=red3[,c("east","north")], date=red3$date, 
                        id=red3$Id, infolocs = red3[,c("Id","Hpes","east","north")])
 
 red4 = ld(red3.ltraj)
 red4$spd_mps = red4$dist / red4$dt
```
 
 

