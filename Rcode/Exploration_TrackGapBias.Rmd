---
title: "Exploring Spatial Bias in Track Gaps"
author: "Anna Steel"
date: "July 11, 2016"
output: html_document
---

#####When I looked at the sample tracks from the KML file, I was not struck by an overwhelming bias in the location of track gaps, as Jon has mentioned. The following exploration was my attempt to visualize the gaps more directly and see where the bias in array performance / post-processing positioning was strongest.

#####I extracted  gaps in each track where consective positions were >20, >50, and >100 meters apart (along a linear path). (These thresholds are easily modified to explore other gap-sizes.)


```{r, echo=FALSE, message=FALSE}
 library(dplyr)
 library(ggplot2)
 options(digits.secs=6)

dat.all = read.csv("C:/Users/Anna/Documents/GitHub/Fremont16/AllPositions/AllFish.csv")
 dat.all$Time = as.POSIXct(dat.all$Time, format="%Y-%m-%d %H:%M:%OS")
#  print(paste("Total Fish Tracked =", length(unique(dat.all$Id))))
#  print(paste("Total Fish Positions =", nrow(dat.all)))
 
dat = dat.all[dat.all$Hpes < 2,]
dat = dat[!(dat$Id %in% c(36472, 36612)),]

# print(paste("Course Filtered: Fish Tracked =", length(unique(dat$Id))))
#  print(paste("Course Filtered: Fish Positions =", nrow(dat)))


datgap = dat %>%
  group_by(Id) %>%
  mutate(distX_m = c(NA,diff(X)), distY_m = c(NA,diff(Y)))%>%  # dist from prev position
  mutate(dist_m = sqrt(distX_m^2 + distY_m^2)) %>%
  mutate(prevX = X - distX_m, prevY = Y - distY_m) %>%
  data.frame()
  
```
  
  
***

#####In the following plots the Green dots indicate the beginning of a gap in which a fish moves downstream, and red dots indicate the beginning of a gap in which a fish moves upstream. Each point is followed by a line representing the distance of the gap in the track. 
  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
### read in and create river outline
   library(rgdal)
   library(maptools)
   river = readOGR("C:/Users/Anna/Documents/GitHub/Fremont16/GIS/2004_channel","2004_channel_freTightclipWGS84")
    
      # read in the river channel and project properly
       vemco.wgs84 <- CRS("+proj=longlat +datum=WGS84")
       river2 = readShapeSpatial("C:/Users/Anna/Documents/GitHub/Fremont16/GIS/2004_channel/2004_channel_freTightclipWGS84.shp", proj4string = vemco.wgs84)

      # reproject to same azimuthal equidistant system (meter-based grid) used for XY fish positions
        river3 <- spTransform(river2,
                        CRS=CRS("+proj=aeqd +lat_0=38.759985 +lon_0=-121.666908 +x_0=1000 +y_0=1000 +datum=WGS84"))
             
      # convert to be useful in ggplot; still not sure what this actually does       
        f_river3 <- fortify(river3, region="BYDEL")
    

### plots ###
ggplot(data = datgap[datgap$dist_m>20,], aes(x=prevX, y=prevY, colour=dist_m)) + 
  geom_path(data = f_river3, aes(long, lat), col="gold", size=1.2) + 
  geom_segment(aes(x=X, xend=prevX, y=Y, yend=prevY), alpha=.5, lineend="round", size=1) + 
  geom_point(data = datgap[datgap$dist_m>20 & datgap$distX_m<0,], colour="red") + 
  geom_point(data = datgap[datgap$dist_m>20 & datgap$distX_m>0,], colour="green3") + 
  coord_fixed(ratio=1) + xlim(river3@bbox[1,1], river3@bbox[1,2]) + ylim(river3@bbox[2,1], river3@bbox[2,2]) + 
  theme_bw() + labs(x = "X", y="Y", title="All Track Gaps > 20m")

ggplot(data = datgap[datgap$dist_m>50,], aes(x=prevX, y=prevY, colour=dist_m)) + 
  geom_path(data = f_river3, aes(long, lat), col="gold", size=1.2) + 
  geom_segment(aes(x=X, xend=prevX, y=Y, yend=prevY), alpha=.5, lineend="round", size=1) + 
  geom_point(data = datgap[datgap$dist_m>50 & datgap$distX_m<0,], colour="red") + 
  geom_point(data = datgap[datgap$dist_m>50 & datgap$distX_m>0,], colour="green3") + 
  coord_fixed(ratio=1) + xlim(river3@bbox[1,1], river3@bbox[1,2]) + ylim(river3@bbox[2,1], river3@bbox[2,2]) + 
  theme_bw() + labs(x = "X", y="Y", title="All Track Gaps > 50m")
 
ggplot(data = datgap[datgap$dist_m>100,], aes(x=prevX, y=prevY, colour=dist_m)) + 
  geom_path(data = f_river3, aes(long, lat), col="gold", size=1.2) + 
  geom_segment(aes(x=X, xend=prevX, y=Y, yend=prevY), alpha=.5, lineend="round", size=1) + 
  geom_point(data = datgap[datgap$dist_m>100 & datgap$distX_m<0,], colour="red") + 
  geom_point(data = datgap[datgap$dist_m>100 & datgap$distX_m>0,], colour="green3") + 
  coord_fixed(ratio=1) + xlim(river3@bbox[1,1], river3@bbox[1,2]) + ylim(river3@bbox[2,1], river3@bbox[2,2]) + 
  theme_bw() + labs(x = "X", y="Y", title="All Track Gaps > 100m")
  
 
```




##### If we assume, for now, that those gaps which progress upstream are due to poor filtering of erroneous positions, then we can plot only the 'downstream gaps' to reduce clutter in the plots:

```{r, echo=FALSE, warning=FALSE}
ggplot(data = datgap[datgap$dist_m>20 & datgap$distX_m>0,], aes(x=prevX, y=prevY, colour=dist_m)) +     
  geom_path(data = f_river3, aes(long, lat), col="gold", size=1.2) + 
  geom_segment(aes(x=X, xend=prevX, y=Y, yend=prevY), alpha=.5, lineend="round", size=1) + 
  geom_point(colour="green3") + 
  coord_fixed(ratio=1) + xlim(river3@bbox[1,1], river3@bbox[1,2]) + ylim(river3@bbox[2,1], river3@bbox[2,2]) + 
  theme_bw() + labs(x = "X", y="Y", title="All Track Gaps > 20m")

ggplot(data = datgap[datgap$dist_m>50 & datgap$distX_m>0,], aes(x=prevX, y=prevY, colour=dist_m)) +     
  geom_path(data = f_river3, aes(long, lat), col="gold", size=1.2) + 
  geom_segment(aes(x=X, xend=prevX, y=Y, yend=prevY), alpha=.5, lineend="round", size=1) + 
  geom_point(colour="green3") +
  coord_fixed(ratio=1) + xlim(river3@bbox[1,1], river3@bbox[1,2]) + ylim(river3@bbox[2,1], river3@bbox[2,2]) + 
  theme_bw() + labs(x = "X", y="Y", title="All Track Gaps > 50m")
 
ggplot(data = datgap[datgap$dist_m>100 & datgap$distX_m>0,], aes(x=prevX, y=prevY, colour=dist_m)) + 
  geom_path(data = f_river3, aes(long, lat), col="gold", size=1.2) + 
  geom_segment(aes(x=X, xend=prevX, y=Y, yend=prevY), alpha=.5, lineend="round", size=1) + 
  geom_point(colour="green3") + 
  coord_fixed(ratio=1) + xlim(river3@bbox[1,1], river3@bbox[1,2]) + ylim(river3@bbox[2,1], river3@bbox[2,2]) + 
  theme_bw() + labs(x = "X", y="Y", title="All Track Gaps > 100m")

```


####After reviewing the plots, my subjective conclusion is that there is a location just past halfway through the array, in the center-right of the channel, where positioning seems to be less reliable. While I don't think the bias is necessarily due to fish swimming near the outside edge of the array in the channel bend (but please feel free to disagree!), there is a systematic bias. If we are confident in the interpolated data that Aaron can produce, it does seem beneficial to use the improved tracks to provide more consistent spatial coverage. What is Aaron's approach? 

***

## Note:
#####These data have been coarsely filtered at an HPE of 2.
#####Additionally, two fish with tracks suggestive of predation (passed through the array but returned 13 days or 12 hours later and passed upstream) were removed. Will be revisited later to complete a more nuanced filteration.

```{r, echo=FALSE}
uppercuttoff = 500
hist(dat.all$Hpes, xlim=c(0,uppercuttoff), breaks=1000, ylim=c(0,100), xlab="HPEs", main=paste0("All Fish Positions\n n=",nrow(dat.all)))
text(400,60, paste0("Additional ",nrow(dat.all[dat.all$Hpes>uppercuttoff,])," positions \nwith HPEs > ",uppercuttoff))
text(400,40, paste0("Overall, ",round(nrow(dat.all[dat.all$Hpes>50,]) / nrow(dat.all)*100,2),"% of positions > 50 HPEs"))
text(400,30, paste0("Overall, ",round(nrow(dat.all[dat.all$Hpes>2,]) / nrow(dat.all)*100,1),"% of positions > 2.0 HPEs"))

trash = dat.all[dat.all$Id==36472,]
 trash1 = trash[trash$Time < as.POSIXct("2016-03-01"),]
 trash2 = trash[trash$Time > as.POSIXct("2016-03-01"),]
plot(trash1$X, trash1$Y, col="green3", type="o", pch=16, ylim=c(900,1300), xlim=c(650,1150), main="TagID 36472 - likely predation event")
points(trash2$X, trash2$Y, col="red", type="o", pch=17)
legend("topleft", legend=c("downstream","upstream"), col=c("green3","red"), pch=c(16,17))

tsh = dat.all[dat.all$Id==36612,]
 tsh1 = tsh[tsh$Time < as.POSIXct("2016-02-23 17:00:00"),]
 tsh2 = tsh[tsh$Time > as.POSIXct("2016-02-23 17:00:00"),]
plot(tsh1$X, tsh1$Y, col="green3", type="o", pch=16, ylim=c(875,1300), xlim=c(650,1150), main="TagID 36612 - likely predation event")
points(tsh2$X, tsh2$Y, col="red", type="o", pch=17)
legend("topleft", legend=c("downstream","upstream"), col=c("green3","red"), pch=c(16,17))
    
```




## Relationship between Gap Length and Time:
##### Just because I was curious, here is the plot of the length of the gap (all gaps >20m) and the time between consecutive positions. The result isn't what I'd expected, and deserves a little more thinking...

```{r, echo=FALSE, warning=FALSE}

datgap2 = datgap%>%
  group_by(Id) %>%
  mutate(timegap_s = c(NA,diff(Time)))%>%
 data.frame()    

datgap3 = datgap2[!is.na(datgap2$timegap_s),]

ggplot(data = datgap3[datgap3$dist_m>20,], aes(x=dist_m, y=timegap_s)) + geom_point(colour="steelblue", alpha=.7, pch=16) + 
  theme_bw()

ggplot(data = datgap3[datgap3$dist_m>20,], aes(x=dist_m, y=timegap_s)) + geom_point(colour="steelblue", alpha=.7, pch=16) + 
  theme_bw() + ylim(0,200)
```



__That's all for now!__
_July 11, 2016_
